# .github/workflows/daily_mlb_report.yml
name: Daily MLB Report

on:
  schedule:
    - cron: '30 20 * * *'  # 日本時間 午前5時30分（UTCで20:30）
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Setup locale for Japanese
      run: |
        sudo apt-get update
        sudo apt-get install -y locales
        sudo locale-gen ja_JP.UTF-8
        echo "LANG=ja_JP.UTF-8" >> $GITHUB_ENV
        echo "LC_ALL=ja_JP.UTF-8" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests beautifulsoup4 pytz lxml
        pip install google-auth google-auth-oauthlib google-auth-httplib2
        pip install google-api-python-client
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Create necessary directories
      run: |
        mkdir -p cache cache/splits_data cache/advanced_stats
        mkdir -p cache/bullpen_stats cache/batting_quality
        mkdir -p cache/recent_ops cache/statcast_data
        mkdir -p logs daily_reports src scripts
    
    - name: Generate MLB Report with UTF-8
      env:
        PYTHONIOENCODING: utf-8
        LANG: ja_JP.UTF-8
        LC_ALL: ja_JP.UTF-8
        LC_CTYPE: ja_JP.UTF-8
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "🚀 レポート生成開始..."
        echo "Locale: $(locale)"
        
        # UTF-8でレポート生成
        python -u scripts/mlb_complete_report_real.py
        
        # ファイル確認
        echo "=== Generated files ==="
        ls -la daily_reports/
        
        # 最新ファイルの確認
        if ls daily_reports/MLB*.txt 1> /dev/null 2>&1; then
          echo "✅ レポート生成成功"
          LATEST=$(ls -t daily_reports/MLB*.txt | head -n1)
          echo "Latest report: $LATEST"
          echo "=== Report Preview ==="
          head -n 10 "$LATEST"
        fi
    
    - name: Upload to Google Drive
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: |
        echo "📤 Google Driveへアップロード開始..."
        python scripts/upload_to_drive.py
    
    - name: Upload Report as Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mlb-report-${{ github.run_number }}
        path: daily_reports/
        retention-days: 30
    
    - name: Commit report
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add daily_reports/*.txt
        git commit -m "Add daily MLB report $(date +%Y%m%d)" || echo "No changes to commit"
        git push
    
    - name: Summary
      if: always()
      run: |
        echo "## 📊 MLB Daily Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Date: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "- Status: Complete" >> $GITHUB_STEP_SUMMARY
        if ls daily_reports/MLB*.txt 1> /dev/null 2>&1; then
          LATEST=$(ls -t daily_reports/MLB*.txt | head -n1)
          echo "- Lines: $(wc -l < $LATEST)" >> $GITHUB_STEP_SUMMARY
          echo "- File: $(basename $LATEST)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📁 Google Drive" >> $GITHUB_STEP_SUMMARY
        echo "Upload status: Check logs for details" >> $GITHUB_STEP_SUMMARY