name: Daily MLB Report

on:
  schedule:
    - cron: '30 10 * * *'  # æ—¥æœ¬æ™‚é–“ 19:30ï¼ˆUTC 10:30ï¼‰
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Setup locale for Japanese
      run: |
        sudo apt-get update
        sudo apt-get install -y locales
        sudo locale-gen ja_JP.UTF-8
        echo "LANG=ja_JP.UTF-8" >> $GITHUB_ENV
        echo "LC_ALL=ja_JP.UTF-8" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests beautifulsoup4 pytz lxml
        pip install google-auth google-auth-oauthlib google-auth-httplib2
        pip install google-api-python-client
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Install PDF dependencies
      run: |
        # WeasyPrintç”¨ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        sudo apt-get update
        sudo apt-get install -y python3-cffi python3-brotli libpango-1.0-0 libpangoft2-1.0-0
        sudo apt-get install -y fonts-noto-cjk fonts-noto
        pip install weasyprint
    
    - name: Create necessary directories
      run: |
        mkdir -p cache cache/splits_data cache/advanced_stats
        mkdir -p cache/bullpen_stats cache/batting_quality
        mkdir -p cache/recent_ops cache/statcast_data
        mkdir -p cache/pitcher_info
        mkdir -p logs daily_reports daily_reports/html daily_reports/pdf
        mkdir -p src scripts
    
    - name: Generate MLB Report with UTF-8
      env:
        PYTHONIOENCODING: utf-8
        LANG: ja_JP.UTF-8
        LC_ALL: ja_JP.UTF-8
        LC_CTYPE: ja_JP.UTF-8
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸš€ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹..."
        echo "Locale: $(locale)"
        
        # UTF-8ã§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        python -u scripts/mlb_complete_report_real.py
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        echo "=== Generated files ==="
        ls -la daily_reports/
        
        # æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if ls daily_reports/MLB*.txt 1> /dev/null 2>&1; then
          echo "âœ… ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆæˆåŠŸ"
          LATEST=$(ls -t daily_reports/MLB*.txt | head -n1)
          echo "Latest report: $LATEST"
          echo "=== Report Preview ==="
          head -n 10 "$LATEST"
        fi
    
    - name: Convert to HTML and PDF
      env:
        PYTHONIOENCODING: utf-8
        LANG: ja_JP.UTF-8
        LC_ALL: ja_JP.UTF-8
      run: |
        echo "ðŸ“„ HTML/PDFå¤‰æ›é–‹å§‹..."
        
        # æœ€æ–°ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’æŽ¢ã™
        LATEST_REPORT=$(ls -t daily_reports/MLB*.txt 2>/dev/null | head -n1)
        
        if [ -f "$LATEST_REPORT" ]; then
          echo "Converting to HTML: $LATEST_REPORT"
          python scripts/convert_to_html.py "$LATEST_REPORT"
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ã™
          LATEST_HTML=$(ls -t daily_reports/html/MLB*.html 2>/dev/null | head -n1)
          if [ -f "$LATEST_HTML" ]; then
            echo "Converting to PDF: $LATEST_HTML"
            python scripts/convert_to_pdf.py "$LATEST_HTML"
            echo "âœ… PDF conversion complete"
          fi
        fi
        
        # å¤‰æ›çµæžœã®ç¢ºèª
        echo "=== Converted files ==="
        ls -la daily_reports/html/ 2>/dev/null || echo "No HTML files"
        ls -la daily_reports/pdf/ 2>/dev/null || echo "No PDF files"
    
    - name: Upload to Google Drive
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: |
        echo "ðŸ“¤ Google Driveã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹..."
        
        # ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        python scripts/upload_to_drive.py
        
        # PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if ls daily_reports/pdf/MLB*.pdf 1> /dev/null 2>&1; then
          LATEST_PDF=$(ls -t daily_reports/pdf/MLB*.pdf | head -n1)
          echo "ðŸ“¤ Uploading PDF to Google Drive: $LATEST_PDF"
          # PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆupload_to_drive.pyã®æ‹¡å¼µç‰ˆãŒå¿…è¦ï¼‰
        fi
    
    - name: Upload Report as Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mlb-report-${{ github.run_number }}
        path: |
          daily_reports/*.txt
          daily_reports/html/*.html
          daily_reports/pdf/*.pdf
        retention-days: 30
    
    - name: Commit report
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # ã™ã¹ã¦ã®å½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
        git add daily_reports/*.txt 2>/dev/null || true
        git add daily_reports/html/*.html 2>/dev/null || true
        git add daily_reports/pdf/*.pdf 2>/dev/null || true
        
        git commit -m "Add daily MLB report $(date +%Y%m%d)" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Summary
      if: always()
      run: |
        echo "## ðŸ“Š MLB Daily Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Date: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "- Time: æ—¥æœ¬æ™‚é–“ 19:30" >> $GITHUB_STEP_SUMMARY
        echo "- Status: Complete" >> $GITHUB_STEP_SUMMARY
        
        if ls daily_reports/MLB*.txt 1> /dev/null 2>&1; then
          LATEST=$(ls -t daily_reports/MLB*.txt | head -n1)
          echo "- Text Report: $(basename $LATEST)" >> $GITHUB_STEP_SUMMARY
          echo "  - Lines: $(wc -l < $LATEST)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if ls daily_reports/html/MLB*.html 1> /dev/null 2>&1; then
          echo "- HTML Report: âœ… Generated" >> $GITHUB_STEP_SUMMARY
        fi
        
        if ls daily_reports/pdf/MLB*.pdf 1> /dev/null 2>&1; then
          echo "- PDF Report: âœ… Generated" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Google Drive" >> $GITHUB_STEP_SUMMARY
        echo "Upload status: Check logs for details" >> $GITHUB_STEP_SUMMARY
        echo "Folder ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}" >> $GITHUB_STEP_SUMMARY