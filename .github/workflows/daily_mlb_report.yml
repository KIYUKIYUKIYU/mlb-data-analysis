name: Daily MLB Report

on:
  schedule:
    # 毎日日本時間18:30に実行（UTCで09:30）
    - cron: '30 9 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 基本パッケージのインストール
        pip install pandas numpy requests beautifulsoup4 pytz
        # Google Drive用（オプション）
        pip install google-api-python-client google-auth-oauthlib google-auth-httplib2
        # もしrequirements.txtがあれば使用
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Create necessary directories
      run: |
        mkdir -p cache
        mkdir -p cache/splits_data
        mkdir -p cache/advanced_stats
        mkdir -p cache/bullpen_stats
        mkdir -p cache/batting_quality
        mkdir -p cache/recent_ops
        mkdir -p cache/statcast_data
        mkdir -p logs
        mkdir -p daily_reports
        mkdir -p scripts
    
    - name: Generate MLB Report
      env:
        PYTHONIOENCODING: utf-8
        PYTHONPATH: ${{ github.workspace }}
      run: |
        # scriptsフォルダにファイルがある場合
        if [ -f scripts/mlb_complete_report_real.py ]; then
          echo "Running from scripts folder..."
          python scripts/mlb_complete_report_real.py > daily_reports/report_$(date +%Y%m%d).txt 2>&1
        # ルートフォルダにファイルがある場合  
        elif [ -f mlb_complete_report_real.py ]; then
          echo "Running from root folder..."
          python mlb_complete_report_real.py > daily_reports/report_$(date +%Y%m%d).txt 2>&1
        else
          echo "Error: mlb_complete_report_real.py not found!"
          exit 1
        fi
        
        # レポートの内容を表示（デバッグ用）
        echo "=== Report Generated ==="
        tail -n 50 daily_reports/report_$(date +%Y%m%d).txt
    
    - name: Upload report as artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: mlb-daily-report
        path: daily_reports/
    
    - name: Check for errors
      run: |
        # エラーログがあれば表示
        if [ -f logs/error.log ]; then
          echo "=== Error Log ==="
          cat logs/error.log
        fi
    
    - name: Commit reports to repository (optional)
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add daily_reports/
        git diff --quiet && git diff --staged --quiet || (git commit -m "Add daily MLB report $(date +%Y-%m-%d)" && git push)
      continue-on-error: true
    
    - name: Send success notification
      if: success()
      run: |
        echo "✅ レポート生成成功！"
        echo "📅 Date: $(date +%Y-%m-%d)"
        echo "📄 Report saved to: daily_reports/report_$(date +%Y%m%d).txt"